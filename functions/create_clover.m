close all; clear;
elem_pos = [0.00243067956032876 0 -0.0749606016309568;-0.00310436758414129 0.00284385500290236 -0.0748817427055821;0.000475173215337688 -0.00541435370477637 -0.0748028006452633;0.00391285427256261 0.00510362550709675 -0.0747237751865161;-0.00718056882460891 -0.00127014151969557 -0.0746446660644617;0.00680206163350748 -0.00432691482571192 -0.074565473012816;-0.00227515649711862 0.008463468765147 -0.0744861957638796;-0.00433897018410803 -0.00835442305706514 -0.0744068340485267;0.00941382972177598 0.00343791551589145 -0.074327387596195;-0.00979352118565911 0.00404262317821561 -0.0742478561348743;0.00472112435775092 -0.0100887685285991 -0.0741682393910965;0.00348879081252979 0.0111228148659145 -0.0740885370899237;-0.0105152560145725 -0.0060938057954777 -0.0740087489549378;0.0123355922741238 -0.00271194535740986 -0.0739288747082289;-0.00752821994174471 0.0107081181882587 -0.0738489140703843;-0.00173919312767056 -0.0134212333315409 -0.0737688667604769;0.0106769399776036 0.00899853631651556 -0.073688732496054;-0.0143678143822323 0.000594154233107641 -0.073608510993125;0.0104802176543028 -0.0104292163436875 -0.0735282019661504;-0.000701167164182373 0.0151633863791329 -0.0734478051280295;-0.00997196074389102 -0.0119497417146688 -0.0733673201900887;0.0157966868747915 0.00212542187689661 -0.0732867468620691;-0.0133845008403057 0.00931258706702155 -0.0732060848521146;0.00365741548141008 -0.0162575785057721 -0.0731253338667592;0.00845941173395157 0.0147628014360582 -0.073044493610915;-0.0165373405450685 -0.00527586268504338 -0.0729635637878592;0.016063921769246 -0.00742193930294124 -0.0728825440992217;-0.00695929229445609 0.016628873161923 -0.0728014342449721;-0.00621101503091224 -0.0172682040296836 -0.0727202339234068;0.0165268443856315 0.00868604622530407 -0.0726389428311357;-0.0183571657506679 0.00483888997885916 -0.0725575606630694;0.0104343397061748 -0.0162277956534812 -0.0724760871124056;0.00331922506929521 0.0193136207911505 -0.0723945218706153;-0.0157302147143342 -0.0121823624316446 -0.0723128646274299;0.0201218030771523 -0.00166705025398296 -0.0722311150708266;-0.0139084074637307 0.015034580928574 -0.0721492728870153;0.000101310768690043 -0.0207674881546408 -0.0720673377604237;0.0141433859938171 0.0155910187930391 -0.071985309373684;-0.0212381088109294 -0.00196834315100925 -0.0719031874076178;0.0172091509653745 -0.0130611320307984 -0.0718209715412218;-0.00391546563411303 0.0215228618448635 -0.0717386614516538;-0.0117943083763241 -0.0187423357482244 -0.0716562568142169;0.0216128036584967 0.0059231734437099 -0.0715737573023451;-0.0201708518340249 0.0103513481327224 -0.0714911625875884;0.00797119609442288 -0.0215009327925385 -0.0714084723395971;0.00874256539567278 0.0214758942695615 -0.0713256862261065;-0.0211822578872732 -0.0100386673130478 -0.0712428039129216;0.0226397407902706 -0.0069800740557932 -0.071159825063901;-0.0121043045818393 0.0206538498521478 -0.0710767493409413;-0.00507768910316104 -0.0236459126012645 -0.0709935764039607;0.0199148772908815 0.014146595990348 -0.0709103059108829;-0.0244793274310111 0.00305081143310231 -0.0708269375176211;0.0161439922088537 -0.0189666244673498 -0.0707434708780605;0.000916297240348517 0.0251264429186132 -0.0706599056440426;-0.0178124913185166 -0.0180751014838858 -0.0705762414653472;0.0255753886006334 0.00130768681326572 -0.0704924779896763;-0.0199188856234288 0.0164579752292243 -0.070408614862636;0.0036018213719019 -0.0258160849506642 -0.0703246517277192;0.0149106344825735 0.0216548549972539 -0.0702405882262884;-0.025840348102277 -0.00594580371591188 -0.0701564239975571;0.0232632606337329 -0.0131800334905498 -0.0700721586785722;-0.00831852717327823 0.0256419790586146 -0.0699877919041957;-0.0112776700931974 -0.0247252815533818 -0.0699033233070861;0.0252168363628411 0.0106982690527344 -0.0698187525176796];
x0 = elem_pos(:, 1)*1e3;  % element x positions
y0 = elem_pos(:, 2)*1e3;
z0 = elem_pos(:, 3)*1e3;

% --- Parameters ---
D = 55; % diameter of each transducer in mm
R = 75;  % radius of curvature (sphere radius)

% Convert diameter to angular rotation (in degrees)
theta_aperture_deg = (D / R) * (180/pi);  % angular width corresponding to diameter

% Set angles so the transducers just touch, e.g. three around circle:
angles_deg = [0, theta_aperture_deg, -theta_aperture_deg];
focal_point = [0, 0, 0];

% --- Transducer 1 at (R, 0, 0) ---
center0 = [R, 0, 0];  % center of first transducer

positions_local = [x0, y0, z0] - center0;  % relative to center

% --- Setup storage ---
x_all = [];
y_all = [];
z_all = [];

% --- Visualization ---
figure; hold on; axis equal;
colors = lines(length(angles_deg));

for i = 1:length(angles_deg)
    angle_deg = angles_deg(i);
    angle_rad = deg2rad(angle_deg);

    % --- Rotation axis: perpendicular to (center0 - focal_point)
    v = center0 - focal_point;
    v = v / norm(v);
    reference = [0, 0, 1];
    if abs(dot(v, reference)) > 0.99
        reference = [0, 1, 0];
    end
    rot_axis = cross(v, reference);
    rot_axis = rot_axis / norm(rot_axis);

    % --- Rodrigues' rotation matrix ---
    k = rot_axis(:);
    K = [   0    -k(3)  k(2);
          k(3)   0    -k(1);
         -k(2)  k(1)   0 ];
    R_rot = eye(3) + sin(angle_rad)*K + (1 - cos(angle_rad))*(K*K);

    % --- Rotate center and elements ---
    center_rot = (R_rot * center0')';
    elems_rot = (R_rot * positions_local')' + center_rot;

    % --- Store ---
    x_all = [x_all; elems_rot(:,1)];
    y_all = [y_all; elems_rot(:,2)];
    z_all = [z_all; elems_rot(:,3)];

    % --- Plot ---
    scatter3(elems_rot(:,1), elems_rot(:,2), elems_rot(:,3), 15, colors(i,:), 'filled');
    plot3([center_rot(1), focal_point(1)], ...
          [center_rot(2), focal_point(2)], ...
          [center_rot(3), focal_point(3)], 'k--');
end

% --- Plot focus ---
scatter3(focal_point(1), focal_point(2), focal_point(3), 100, 'r', 'filled');

xlabel('X [mm]');
ylabel('Y [mm]');
zlabel('Z [mm]');
title('Three Touching Transducers on a Sphere (Clover Layout)');
grid on;