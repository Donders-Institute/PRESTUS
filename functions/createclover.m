close all; clear;
%elem_pos = [0.00243067956032876 0 -0.0749606016309568;-0.00310436758414129 0.00284385500290236 -0.0748817427055821;0.000475173215337688 -0.00541435370477637 -0.0748028006452633;0.00391285427256261 0.00510362550709675 -0.0747237751865161;-0.00718056882460891 -0.00127014151969557 -0.0746446660644617;0.00680206163350748 -0.00432691482571192 -0.074565473012816;-0.00227515649711862 0.008463468765147 -0.0744861957638796;-0.00433897018410803 -0.00835442305706514 -0.0744068340485267;0.00941382972177598 0.00343791551589145 -0.074327387596195;-0.00979352118565911 0.00404262317821561 -0.0742478561348743;0.00472112435775092 -0.0100887685285991 -0.0741682393910965;0.00348879081252979 0.0111228148659145 -0.0740885370899237;-0.0105152560145725 -0.0060938057954777 -0.0740087489549378;0.0123355922741238 -0.00271194535740986 -0.0739288747082289;-0.00752821994174471 0.0107081181882587 -0.0738489140703843;-0.00173919312767056 -0.0134212333315409 -0.0737688667604769;0.0106769399776036 0.00899853631651556 -0.073688732496054;-0.0143678143822323 0.000594154233107641 -0.073608510993125;0.0104802176543028 -0.0104292163436875 -0.0735282019661504;-0.000701167164182373 0.0151633863791329 -0.0734478051280295;-0.00997196074389102 -0.0119497417146688 -0.0733673201900887;0.0157966868747915 0.00212542187689661 -0.0732867468620691;-0.0133845008403057 0.00931258706702155 -0.0732060848521146;0.00365741548141008 -0.0162575785057721 -0.0731253338667592;0.00845941173395157 0.0147628014360582 -0.073044493610915;-0.0165373405450685 -0.00527586268504338 -0.0729635637878592;0.016063921769246 -0.00742193930294124 -0.0728825440992217;-0.00695929229445609 0.016628873161923 -0.0728014342449721;-0.00621101503091224 -0.0172682040296836 -0.0727202339234068;0.0165268443856315 0.00868604622530407 -0.0726389428311357;-0.0183571657506679 0.00483888997885916 -0.0725575606630694;0.0104343397061748 -0.0162277956534812 -0.0724760871124056;0.00331922506929521 0.0193136207911505 -0.0723945218706153;-0.0157302147143342 -0.0121823624316446 -0.0723128646274299;0.0201218030771523 -0.00166705025398296 -0.0722311150708266;-0.0139084074637307 0.015034580928574 -0.0721492728870153;0.000101310768690043 -0.0207674881546408 -0.0720673377604237;0.0141433859938171 0.0155910187930391 -0.071985309373684;-0.0212381088109294 -0.00196834315100925 -0.0719031874076178;0.0172091509653745 -0.0130611320307984 -0.0718209715412218;-0.00391546563411303 0.0215228618448635 -0.0717386614516538;-0.0117943083763241 -0.0187423357482244 -0.0716562568142169;0.0216128036584967 0.0059231734437099 -0.0715737573023451;-0.0201708518340249 0.0103513481327224 -0.0714911625875884;0.00797119609442288 -0.0215009327925385 -0.0714084723395971;0.00874256539567278 0.0214758942695615 -0.0713256862261065;-0.0211822578872732 -0.0100386673130478 -0.0712428039129216;0.0226397407902706 -0.0069800740557932 -0.071159825063901;-0.0121043045818393 0.0206538498521478 -0.0710767493409413;-0.00507768910316104 -0.0236459126012645 -0.0709935764039607;0.0199148772908815 0.014146595990348 -0.0709103059108829;-0.0244793274310111 0.00305081143310231 -0.0708269375176211;0.0161439922088537 -0.0189666244673498 -0.0707434708780605;0.000916297240348517 0.0251264429186132 -0.0706599056440426;-0.0178124913185166 -0.0180751014838858 -0.0705762414653472;0.0255753886006334 0.00130768681326572 -0.0704924779896763;-0.0199188856234288 0.0164579752292243 -0.070408614862636;0.0036018213719019 -0.0258160849506642 -0.0703246517277192;0.0149106344825735 0.0216548549972539 -0.0702405882262884;-0.025840348102277 -0.00594580371591188 -0.0701564239975571;0.0232632606337329 -0.0131800334905498 -0.0700721586785722;-0.00831852717327823 0.0256419790586146 -0.0699877919041957;-0.0112776700931974 -0.0247252815533818 -0.0699033233070861;0.0252168363628411 0.0106982690527344 -0.0698187525176796];
transducer_pars.Elements_OD_mm = 55;

% sub-array ROC75
%elem_pos = [0.00843067956032876 0.00289563241585872 0.00647517321533769 0.00991285427256261 -0.00118056882460891 0.0128020616335075 0.00372484350288138 0.00166102981589197 0.015413829721776 -0.00379352118565911 0.0107211243577509 0.00948879081252979 -0.00451525601457247 0.0183355922741238 -0.00152821994174472 0.00426080687232944 0.0166769399776036 -0.00836781438223226 0.0164802176543028 0.00529883283581763 -0.00397196074389102 0.0217966868747915 -0.00738450084030566 0.00965741548141008 0.0144594117339516 -0.0105373405450685 0.022063921769246 -0.000959292294456092 -0.00021101503091224 0.0225268443856315 -0.0123571657506679 0.0164343397061748 0.00931922506929521 -0.00973021471433416 0.0261218030771523 -0.00790840746373068 0.00610131076869004 0.0201433859938171 -0.0152381088109294 0.0232091509653745 0.00208453436588697 -0.00579430837632408 0.0276128036584967 -0.0141708518340249 0.0139711960944229 0.0147425653956728 -0.0151822578872732 0.0286397407902706 -0.00610430458183925 0.00092231089683896 0.0259148772908815 -0.0184793274310111 0.0221439922088537 0.00691629724034852 -0.0118124913185166 0.0315753886006334 -0.0139188856234288 0.0096018213719019 0.0209106344825735 -0.019840348102277 0.0292632606337329 -0.00231852717327823 -0.00527767009319742 0.0312168363628411;0.027 0.0298438550029024 0.0215856462952236 0.0321036255070967 0.0257298584803044 0.0226730851742881 0.035463468765147 0.0186455769429349 0.0304379155158915 0.0310426231782156 0.0169112314714009 0.0381228148659145 0.0209061942045223 0.0242880546425901 0.0377081181882587 0.0135787666684591 0.0359985363165156 0.0275941542331076 0.0165707836563125 0.0421633863791329 0.0150502582853312 0.0291254218768966 0.0363125870670215 0.0107424214942279 0.0417628014360582 0.0217241373149566 0.0195780606970588 0.043628873161923 0.00973179597031636 0.0356860462253041 0.0318388899788592 0.0107722043465188 0.0463136207911505 0.0148176375683554 0.025332949746017 0.042034580928574 0.00623251184535916 0.0425910187930391 0.0250316568489908 0.0139388679692016 0.0485228618448635 0.00825766425177556 0.0329231734437099 0.0373513481327224 0.0054990672074615 0.0484758942695615 0.0169613326869522 0.0200199259442068 0.0476538498521478 0.00335408739873549 0.041146595990348 0.0300508114331023 0.00803337553265024 0.0521264429186132 0.00892489851611422 0.0283076868132657 0.0434579752292243 0.0011839150493358 0.0486548549972539 0.0210541962840881 0.0138199665094502 0.0526419790586146 0.00227471844661824 0.0376982690527344;-0.0909606016309568 -0.0908817427055821 -0.0908028006452633 -0.0907237751865161 -0.0906446660644617 -0.090565473012816 -0.0904861957638796 -0.0904068340485267 -0.090327387596195 -0.0902478561348743 -0.0901682393910965 -0.0900885370899237 -0.0900087489549378 -0.0899288747082289 -0.0898489140703843 -0.0897688667604769 -0.089688732496054 -0.089608510993125 -0.0895282019661504 -0.0894478051280295 -0.0893673201900887 -0.0892867468620691 -0.0892060848521146 -0.0891253338667592 -0.089044493610915 -0.0889635637878592 -0.0888825440992217 -0.0888014342449721 -0.0887202339234068 -0.0886389428311357 -0.0885575606630694 -0.0884760871124056 -0.0883945218706153 -0.0883128646274299 -0.0882311150708266 -0.0881492728870153 -0.0880673377604237 -0.087985309373684 -0.0879031874076178 -0.0878209715412218 -0.0877386614516538 -0.0876562568142169 -0.0875737573023451 -0.0874911625875884 -0.0874084723395971 -0.0873256862261065 -0.0872428039129216 -0.087159825063901 -0.0870767493409413 -0.0869935764039607 -0.0869103059108829 -0.0868269375176211 -0.0867434708780605 -0.0866599056440426 -0.0865762414653472 -0.0864924779896763 -0.086408614862636 -0.0863246517277192 -0.0862405882262884 -0.086156423997557 -0.0860721586785722 -0.0859877919041957 -0.0859033233070861 -0.0858187525176796];

% sub-array ROC100
elem_pos = [0.00843067956032876 0.00289563241585872 0.00647517321533769 0.00991285427256261 -0.00118056882460891 0.0128020616335075 0.00372484350288138 0.00166102981589197 0.015413829721776 -0.00379352118565911 0.0107211243577509 0.00948879081252979 -0.00451525601457247 0.0183355922741238 -0.00152821994174472 0.00426080687232944 0.0166769399776036 -0.00836781438223226 0.0164802176543028 0.00529883283581763 -0.00397196074389102 0.0217966868747915 -0.00738450084030566 0.00965741548141008 0.0144594117339516 -0.0105373405450685 0.022063921769246 -0.000959292294456092 -0.00021101503091224 0.0225268443856315 -0.0123571657506679 0.0164343397061748 0.00931922506929521 -0.00973021471433416 0.0261218030771523 -0.00790840746373068 0.00610131076869004 0.0201433859938171 -0.0152381088109294 0.0232091509653745 0.00208453436588697 -0.00579430837632408 0.0276128036584967 -0.0141708518340249 0.0139711960944229 0.0147425653956728 -0.0151822578872732 0.0286397407902706 -0.00610430458183925 0.00092231089683896 0.0259148772908815 -0.0184793274310111 0.0221439922088537 0.00691629724034852 -0.0118124913185166 0.0315753886006334 -0.0139188856234288 0.0096018213719019 0.0209106344825735 -0.019840348102277 0.0292632606337329 -0.00231852717327823 -0.00527767009319742 0.0312168363628411;0.026 0.0288438550029024 0.0205856462952236 0.0311036255070967 0.0247298584803044 0.0216730851742881 0.034463468765147 0.0176455769429349 0.0294379155158915 0.0300426231782156 0.0159112314714009 0.0371228148659145 0.0199061942045223 0.0232880546425901 0.0367081181882587 0.0125787666684591 0.0349985363165156 0.0265941542331076 0.0155707836563125 0.0411633863791329 0.0140502582853312 0.0281254218768966 0.0353125870670215 0.00974242149422793 0.0407628014360582 0.0207241373149566 0.0185780606970588 0.042628873161923 0.00873179597031636 0.0346860462253041 0.0308388899788592 0.0097722043465188 0.0453136207911505 0.0138176375683554 0.024332949746017 0.041034580928574 0.00523251184535916 0.0415910187930391 0.0240316568489908 0.0129388679692016 0.0475228618448635 0.00725766425177556 0.0319231734437099 0.0363513481327224 0.00449906720746149 0.0474758942695615 0.0159613326869522 0.0190199259442068 0.0466538498521478 0.00235408739873549 0.040146595990348 0.0290508114331023 0.00703337553265024 0.0511264429186132 0.00792489851611422 0.0273076868132657 0.0424579752292243 0.000183915049335796 0.0476548549972539 0.0200541962840881 0.0128199665094502 0.0516419790586146 0.00127471844661824 0.0366982690527344;-0.0909704546197275 -0.0909113376480617 -0.0908521856765039 -0.0907929986428156 -0.0907337764845742 -0.0906745191391712 -0.0906152265438121 -0.0905558986355153 -0.0904965353511116 -0.0904371366272431 -0.0903777024003624 -0.0903182326067324 -0.0902587271824246 -0.0901991860633191 -0.0901396091851032 -0.090079996483271 -0.0900203478931225 -0.0899606633497624 -0.0899009427880998 -0.0898411861428473 -0.0897813933485198 -0.089721564339434 -0.0896616990497072 -0.0896017974132571 -0.0895418593638003 -0.0894818848348517 -0.0894218737597238 -0.0893618260715253 -0.0893017417031611 -0.0892416205873305 -0.089181462656527 -0.089121267843037 -0.0890610360789391 -0.0890007672961033 -0.0889404614261899 -0.0888801184006486 -0.0888197381507178 -0.0887593206074234 -0.0886988657015781 -0.0886383733637805 -0.0885778435244139 -0.0885172761136456 -0.0884566710614261 -0.0883960282974876 -0.0883353477513436 -0.0882746293522879 -0.0882138730293933 -0.0881530787115107 -0.0880922463272686 -0.0880313758050714 -0.0879704670730991 -0.0879095200593058 -0.087848534691419 -0.0877875108969386 -0.0877264486031354 -0.087665347737051 -0.0876042082254961 -0.0875430299950493 -0.0874818129720571 -0.0874205570826315 -0.0873592622526501 -0.0872979284077544 -0.0872365554733491 -0.0871751433746007];

focus_pos_m = [0.006;0.026;-0.091+0.075];
trans_pos_m = [0.006;0.026;-0.091];

real_focus_pos_m = focus_pos_m;

x0 = elem_pos(1, :)'*1e3;  % element x positions in mm
y0 = elem_pos(2, :)'*1e3;
z0 = elem_pos(3, :)'*1e3;

% --- Parameters ---
n_leaves = 3;
ROC_tran = 100;
ROC_bowl = 75;  % mm
focus_pos_m(3) = trans_pos_m(3) + ROC_bowl*1e-3;
theta_az = 2 * pi / n_leaves;  % 120Â° between leaves

% Compute radius of circle where centers lie to avoid overlap
radius_circle_of_centers = transducer_pars.Elements_OD_mm(end) / (2 * ROC_bowl * sin(theta_az / 2));

% Compute elevation angle based on ROC
elevation_angle = asin(radius_circle_of_centers);

% --- Focus position ---
focus_pos_mm = focus_pos_m * 1e3;

% --- First transducer center ---
% Place first transducer at desired elevation on ROC sphere (along X-axis azimuthally)
x_c = ROC_bowl * cos(elevation_angle);
y_c = 0;
z_c = ROC_bowl * sin(elevation_angle);
center0 = focus_pos_mm + [x_c; y_c; z_c];

% --- Positions relative to center ---
positions_local = [x0, y0, z0] - center0';

% --- Storage ---
x_all = [];
y_all = [];
z_all = [];

% --- Plot ---
h = figure; hold on; axis equal;
colors = lines(n_leaves);

legend_labels = cell(1, length(n_leaves)); % Pre-allocate legend labels (assuming 'transducers' array)
for i = 0:n_leaves-1
    % --- Step 1: rotate around Z to spread evenly
    angle_z = i * theta_az;
    Rz = [cos(angle_z), -sin(angle_z), 0;
          sin(angle_z),  cos(angle_z), 0;
          0,             0,            1];

    % --- Step 2: rotate around Y to tilt downward (toward focus)
    Ry = [cos(elevation_angle), 0, sin(elevation_angle);
          0,                    1, 0;
         -sin(elevation_angle), 0, cos(elevation_angle)];

    % --- Combined rotation
    R_total = Rz * Ry;

    % --- Rotate center and elements
    % --- Compute rotated center
    center_rot = (R_total * (center0 - focus_pos_mm)) + focus_pos_mm;

    % --- Rotate elements
    elems_rot = (R_total * positions_local')' + center_rot';

    % Residual function for sphere fitting
    residuals = @(c) sqrt(sum((elems_rot - c).^2, 2)) - ROC_tran;
    
    % Initial guess: mean of points
    initial_guess = mean(elems_rot);
    
    % Least squares optimization
    center = lsqnonlin(residuals, initial_guess);
    
    % Compute apex (middle point on the bowl)
    mean_point = mean(elems_rot);
    direction = (mean_point - center) / norm(mean_point - center);
    apex = center + ROC_tran * direction;

    % Vector from true center to focus
    vector_to_focus = focus_pos_mm' - apex;
    
    % Euclidean distance
    distance_to_focus = norm(vector_to_focus);
    
    % Create legend label for this transducer
    legend_labels{i+1} = sprintf('Transducer %d: Dist. to focus = %.2f mm', ...
        i+1, distance_to_focus);

    % --- Store
    x_all = [x_all; elems_rot(:,1)];
    y_all = [y_all; elems_rot(:,2)];
    z_all = [z_all; elems_rot(:,3)];

    % --- Plot
    scatter3(elems_rot(:,1), elems_rot(:,2), elems_rot(:,3), 15, colors(i+1,:), 'filled');
    h0(i+1) = plot3([apex(1), focus_pos_mm(1)], [apex(2), focus_pos_mm(2)], [apex(3), focus_pos_mm(3)], 'k--');               
end

% Plot focus and positions
h1 = scatter3(focus_pos_m(1)*1e3, focus_pos_m(2)*1e3, focus_pos_m(3)*1e3, 100, 'r', 'filled');
h2 = scatter3(real_focus_pos_m(1)*1e3, real_focus_pos_m(2)*1e3, real_focus_pos_m(3)*1e3, 100, 'b', 'filled');
h3 = scatter3(trans_pos_m(1)*1e3, trans_pos_m(2)*1e3, trans_pos_m(3)*1e3, 100, 'g', 'filled');

% Combine legend handles: all transducer bowls + fixed points
legend_handles = [h0, h1, h2, h3];

% Create combined legend labels: all transducers + fixed points
fixed_labels = { "Middle of parent bowl, ROC " + num2str(ROC_bowl, '%.2f') + " mm", "Focus", "Transducer middle" };
legend(legend_handles, [legend_labels, fixed_labels]);

xlabel('X [mm]');
ylabel('Y [mm]');
zlabel('Z [mm]');
title(strcat('3D Clover Transducer Layout, ROC sub-array ', {' '}, num2str(ROC_tran), {' '}, 'mm'));
grid on;